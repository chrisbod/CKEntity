<!DOCTYPE html>
<!--
Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.md or http://ckeditor.com/license
-->
<html>
<head>
	<meta charset="utf-8">
	<title>XHTML Compliant Output &mdash; CKEditor Sample</title>
	<meta name="ckeditor-sample-required-plugins" content="sourcearea">
	<script src="../vendor/jquery/jquery-1.11.2.min.js">

 
	</script>
	<meta name="ckeditor-sample-required-plugins" content="sourcearea">
	<script src="../vendor/ckeditor/ckeditor.js"></script>
	<script src="../vendor/ckeditor/plugins/wallstreetdocs/plugin.js"></script>
	<script src="scripts/selectcontrol.js"></script>
	<script src="scripts/entities.js"></script>
	<script src="scripts/entities.store.js"></script>
	<script src="scripts/entities.languagestore.js"></script>
	<script src="scripts/entities.selection.js"></script>
	<script src="scripts/entities.paste.js"></script>
	<script src="scripts/entities.conditional.collapser.js"></script>
	<script src="scripts/entities.markupmanager.js"></script>
	<script src="scripts/entities.usergenerated.js"></script>
	<script src="scripts/entities.edit.knockout.viewmodels.js"></script>
	<script src="scripts/documenttranslator.js"></script>
	<script src="scripts/intent.js"></script>
	<script src="scripts/positionablecontainer.js"></script>
	<script src="scripts/autosuggest.container.js"></script>
	<script src="scripts/entities.tooltip.js"></script>
	<script src="scripts/sentencetokenizer.js"></script>
	<script src="scripts/tokentokenizer.js"></script>
	<script src="../vendor/knockout/knockout-3.3.0.js"></script>
	<link href="css/autosuggest.css" rel="stylesheet">
	<link href="css/dialog-form.css" rel="stylesheet">
	<link href="css/tooltip.css" rel="stylesheet">
	<link href="css/kid.css" rel="stylesheet">
</head>
<body>
			<style>
			body {
				font-family: Arial, Helvetica, sans-serif;
			}
				span.rules {
					display: inline-block;
					color: rgba(0,0,0,0);
					width: 0;
					overflow: hidden;
				}

			

			</style>

	
	
		<script>


		//window.addEventListener("contextmenu", function (e){event.stopPropagation()},true)
		
	var translationContainer = new AutoSuggestContainer("translation-menu");
	var tokenContainer = new AutoSuggestContainer("token-menu");
	tokenContainer.getLastSentenceFromRange = function (range) {
		var token =  range.toString().match(/(?:\s*)(<)[^>]*$/);
		if (token) {
			return token[1]
		}
		return null;
	}
	var languageStore = new LanguageStore("json/tokens","json/logic","json/translations");
	EntitiesHelper.prototype.languageStore = languageStore;//NASTY....
	var conditionalCollapser = new ConditionalCollapser();
	var entityTooltip = new EntityTooltip()
	var userConditionalManager = new UserConditionalManager();
	var pasteManager = new EntityPasteManager()

	var markupManager = new EntityMarkupManager()
	var entitiesSelection = new EntitySelectionManager()

	var translator = new DocumentTranslator(languageStore)


function build(editor,editPanel,language)  {
	//allow context menu when appropriate

	editPanel.addEventListener("contextmenu", function (event) {
		/*var path = event.path;
		for (var i=0;i<path.length;i++) {
			if (/li|table/i.test(path[i].tagName)) {
				return
			}
		}*/
		event.stopPropagation()
	},true);
	

	function updateAutosuggests(lang) {
		translationContainer.build(languageStore.getTranslationStoreByLanguage(lang),languageStore.getSentenceTokenizerByLanguage(lang))
		tokenContainer.build(languageStore.getTokenStoreByLanguage(lang),languageStore.getTokenTokenizerByLanguage(lang))

	}
	languageStore.installLanguage(language, function (languageDefinition) {
		if (language != languageStore.currentLanguage) {
			translator.translate(editPanel,languageDefinition.id)
			languageStore.setCurrentLanguage(languageDefinition.id);
			updateAutosuggests(languageDefinition.id)
		}
		
		
	});


	entityTooltip.init(editPanel,document.querySelector("#entity-edit"));
	userConditionalManager.init(editPanel)
	conditionalCollapser.init(editPanel)
	markupManager.init(editPanel)
	pasteManager.init(editPanel)
	entitiesSelection.init(editPanel)
	translationContainer.setEditableElement(editPanel);
	tokenContainer.setEditableElement(editPanel);



}
$(function () {

	CKEDITOR.replace( 'documentSource', {
				title: false,
				disableNativeSpellChecker: false,
				allowedContent: true,
				fullPage: true,
				allowedContent: true,
				extraPlugins: 'wysiwygarea,wallstreetdocs,wordpaste,documentlang,knockoutdialog,pagebreaktag',
				removePlugins: 'elementspath,magicline,pastetext,pastefromword,clipboard',
				language_list: [ 'en:English', 'de:German'],

				on :
   {
      // Maximize the editor on start-up.
      'instanceReady' : function( evt )
      {
         evt.editor.execCommand( 'maximize' );
      }
   } 

			});
			var editor = CKEDITOR.instances.documentSource;
			new SaveShim(document.forms[0])
			var localVersion = localStorage.getItem("source")
			if (localVersion) {
				editor.setData(localVersion)
			} else {
				$.ajax('xml/kid.html', {
				success: function (data) {
					
					editor.setData(data, function () {
						//var editDocument = CKEDITOR.instances.documentSource.window.$.document

						//build()

					})



				}
			})
			}
			

			


	
	


})

function SaveShim(form) {
	if (form) {
		this.init(form)
	}
}
SaveShim.prototype = {
	init: function (form) {

		this.form = form;
		this.form.submit = function () {
			var source = this.elements[0].value
			localStorage.setItem("source",source)
		}
	},
	handleEvent: function (event) {
		debugger;
		return this[event.type+"Handler"](event)
	},
	submitHandler: function (event) {
		console.log(event.target)
		event.preventDefault()
		return false
	}


}
		</script>
		<script>
		
		function DeselectEnabler() {

		}
		DeselectEnabler.getInstance = function () {
			if (!this.instance) {
				this.instance = new this()
			} 
			return this.instance;
		}

		DeselectEnabler.prototype = {
			watchSelect: function (element) {
				element.addEventListener("focus",this,true);
				element.addEventListener("blur",this,true);
				element.addEventListener("click",this,true);
				element.addEventListener("change",this,true)
			},
			handleEvent: function (event) {
				this[event.type+"Handler"](event)
			},
			focusHandler: function (event) {
				this.currentSelect = event.target;
				this.selectedOptions = []
				for (var i=0;i<event.target.options.length;i++) {
					if (event.target.options[i].selected) {
						event.target.options[i].className = "checked"
						this.selectedOptions[i] = event.target.options[i];
					} else {
						event.target.options[i].className = ""
					}
				}

			},
			changeHandler: function (event) {
				this.changed = true
				for (var i=0;i<event.target.options.length;i++) {
					if (event.target.options[i].selected) {
						event.target.options[i].className = "checked"
						this.selectedOptions[i] = event.target.options[i];
					} else {
						delete this.selectedOptions[i]
					}
				}
			},
			blurHandler: function (event) {
				this.currentSelect = null;
				this.selectedOptions = null;
				this.changed = false;
			},
			clickHandler: function (event) {
				if (this.changed == false && this.selectedOptions && this.selectedOptions[event.target.index]) {
					this.selectedOptions[event.target.index].selected = false;
					this.selectedOptions[event.target.index].className = "";
				}
				this.changed = false;
			}

		}
		ko.bindingHandlers.minimumSelected = {
    init: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
    	DeselectEnabler.getInstance().watchSelect(element) 
    	//console.log(init)
    },
    update: function(element, valueAccessor, allBindings, viewModel, bindingContext) {
    	//console.log("update")
    	
        // This will be called once when the binding is first applied to an element,
        // and again whenever any observables/computeds that are accessed change
        // Update the DOM element based on the supplied values here
        //console.log(arguments)
       
    },
    handleEvent: function (event) {
    	console.log(event.target)
    }
};
		</script>
		<form action="javascript:;" method="GET">

		<textarea id="documentSource" style="width: 100%; height: 100ex">


		</textarea>
	</form>



		<div class="dialog" data-bind="ckeditorDialog: active" id="tokenDialog">
		
		<form id="test" data-bind="submit: update">
			
			
				
				
				
			<div>
				<div data-bind="foreach: groups">
					<strong data-bind="text: label"></strong>
					<!--tried using a switch here but had scoping issues-->
					<ul data-bind="foreach: controls">
						<!--ko if: type == 'checkbox' -->
						<li>
							<label>
								<input type="checkbox" data-bind="value:value, attr:{name:value}, checked: $root.values()[value]">
								<span data-bind="text:text"></span>
							</label>
						</li>
						<!--/ko-->
						<!--ko if: type == 'radio' -->
						<li>
							<select size="4" data-bind="attr:{name:$parent.id }, options: options , optionsText: 'text', 	optionsValue: 'value', value: $root.values()[id]">
							</select>
								<!--ul data-bind="foreach: options" class="radio-list">
									<li>
										<label>
											<input type="radio" data-bind="value:value, name:$parent.id, checked: $root.values()[$parent.id] == value">
											<span data-bind="text:text"></span><br>
											<span data-bind="text:(JSON.stringify($root.values()))"></span>
										</label>
									</li>
								</ul-->
						</li>
						<!--/ko-->
						<!--ko if: type == 'select' -->
						<li>
							<select data-bind="minimumSelected: 0, attr:{name:id }, options: options, optionsText: 'text', 	optionsValue: 'value', value: $root.values()[id], onclick: $root.checkSelect()">
							</select>
						</li>
						<!--/ko-->
						<!--ko if: type == 'text' -->
						<li>
							<label>
								<div data-bind="text: (typeof label != 'undefined' ?  label : '')"></div>
							<input type="text" data-bind="attr:{name:id, placeholder: (typeof placeholder != 'undefined' ?  placeholder : '')}, value: value "/>
							</label>
						</li>
						<!--/ko-->
						<!--ko if: type == 'textarea' -->
						<li>
							<label>
								<div data-bind="text: (typeof label != 'undefined' ?  label : '')"></div>
							<textarea data-bind="attr:{name:id,placeholder:(typeof placeholder != 'undefined' ?  placeholder : '')}, value: value"></textarea>
							</label>
						</li>
						<!--/ko-->
					</ul>
				</div>     
			</div>
			</form>
		</div>
		<style>
		

		</style>
		<div class="dialog"  data-bind="ckeditorDialog: active" id="logicDialog">
			
		<form id="rules" data-bind="submit: update">
			
			<section>
			<fieldset class="container-content">
				
					<ul data-bind="foreach: logic">
						<li>
							<strong data-bind="text:text"></strong>
							<select size="4" data-bind="minimumSelected: 0,attr:{name:id }, options: items , optionsText: 'text', 	optionsValue: 'value', value: $root.values()[id]">
							</select>
						</li>
					</ul>
				</fieldset>
			</section>
			
			</form>
		</div>

		<div class="tooltip hidden"   data-bind="attr: {'class': 'tooltip' + (active() ? ' active' : ' hidden')}" id="entity-edit">
			

				<header data-bind="text:title()">
					
				</header>
				<fieldset>
					<!--ko if: canEditRules -->
					<button data-bind="click: launchRulesDialog">Rules</button>
					<!--/ko-->
					<!--ko if: canEditProperties-->
					<button data-bind="click: launchPropertiesDialog">Properties</button>
					<!--/ko-->
				</fieldset>
			
		</div>

		<script>


			
					

		</script>
</body>
</html>
